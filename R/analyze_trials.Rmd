---
title: 'MOT ADHD: Behavioral data analysis'
author: "Ben Cowley (adapted from Sami Karadeniz)"
output:
  html_document:
    theme: readable
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

# Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
# Load libraries
#library(Rmisc)
# library(gghalves)
# library(kableExtra)
# library(knitr)
library(forcats)
library(here)
library(ez)
library(retimes)
library(afex)
library(multcomp)
library(emmeans)
library(sjPlot)
library(tidyverse)
source('znbnz_utils.R')

#         THIS SCRIPT IS CREATED USING DUMMY DATA, SO ID IS CODED AS ID_MOT AT SOME PLACEs
# Path to demographics excel-file.
demographics_path <- paste0(here(), "/data/subjects_log.xlsx")

# Path to the folder containing trials data in csv-format.
trials_path <- paste0(here(), "/data/trials")

# Path to figure output folder
SAVE <- FALSE
odir <- paste0(here(), "/Figures/")

# Define the theme of the plots as a variable.
plot_theme <- "theme_minimal"
DIAGNOSTICS <- TRUE
PLOTS <- TRUE
```


```{r load_data, include = FALSE, warning = FALSE}
# Load data import functions.
source("functions/import_trials_data_csv.r")

# Load demographics data.
demographics <- readxl::read_xlsx(demographics_path)

# Load trials data.
trials_data <- import_trials_data(trials_path)
```


```{r recode_variables, include = FALSE, warning = FALSE}
# Re-code variables: demographics.
# demographics$Subj = demographics$ID
demographics$ID_MOT <- as.factor(sprintf('%02d', demographics$ID_MOT))
demographics$ID <- as.factor(demographics$ID)

# Re-code variables: trials data.
trials_data$ID = as.factor(trials_data$ID)
trials_data$Group = as.factor(trials_data$Group)
trials_data$Group <- relevel(trials_data$Group, "Control")
trials_data$Task = as.factor(trials_data$Task)
trials_data$Distractors = as.factor(trials_data$Distractors)
trials_data$TrialType = as.factor(trials_data$TrialType)
trials_data$Hemifield = as.factor(trials_data$Hemifield)
trials_data$Visibility = as.factor(trials_data$Visibility)
trials_data$PhotoD = as.factor(trials_data$PhotoD)
trials_data$Resp = as.factor(trials_data$Resp)
trials_data$Blink = as.factor(trials_data$Blink)
```


# Preprocessing

## Pruning

__Discarding subjects before preprocessing__. First, we use the following criteria for choosing the subjects to be 
preprocessed in the first place:

* subjects have been measured with the photodetector
* subjects have the full number of usable sets (= 4)
* subjects do not have too many trial-rejections

```{r discard_by_photod-sets, warning = FALSE}
  # filter(Photodetector == TRUE, n_sets == 4) %>% 
demographics %>% 
  filter(Valid_for_analysis == TRUE) %>%
  mutate("dom_resp" = Handedness == Response_hand) %>%
  select(ID, dom_resp) %>% 
  inner_join(trials_data, by = "ID") -> analysis_trials
 analysis_trials$ID = as.factor(analysis_trials$ID)

levels(analysis_trials$Resp)[1] <- "Hit"
levels(analysis_trials$Resp)[2] <- "False Alarm"
```


## Check trial-RTs

Let's take a look at the reaction time distribution for each subject.

```{r preproc_rt_original, warning = FALSE, fig.align = "center"}
if (PLOTS){
# Reaction time scatter plot.
analysis_trials %>%
  filter(RT > 0) %>% 
  ggplot(aes(x = ID, y = RT)) +
    geom_jitter() +
    # scale_y_continuous(limits = c(0, 0.700), breaks = seq(0, 0.700, 0.100)) +
    xlab("Subject") +  
    ylab("Reaction time (s)") +
    ggtitle("Reaction time distribution, all subjects, all trials") +
    get(plot_theme)() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Reaction time cumulative distribution.
analysis_trials %>% 
  filter(RT > 0) %>% 
  ggplot(aes(x = RT)) +
    stat_ecdf(aes(color = ID)) +
    scale_y_continuous(labels = scales::percent) +
    scale_color_brewer(palette = "Set1") +
    xlab("Reaction time (s)") +
    ylab(NULL) +
    ggtitle(paste("Cumulative reaction time distribution, all subjects,",
                  "all trials")) +
    get(plot_theme)() +
    theme(legend.position = "none") 
}
```


If we believe that the RT distribution tails reflect theoretically invalid processes, we could consider trimming them, i.e. discard trials whose RT's are above or below some theoretical limit.

* less than 180 ms (which is mean minus 2SD, based on Table 2 from Woods, et al., 2015 Front Hum Neurosci. 2015; 9:131)
* above median + 5 times the median absolute deviation (but we have no theoretical justification for this)

_However_, we actually have no strong motivation for this approach, since

(a) it is not clear where the threshold should be
(b) we aim to use parametric test statistics (based on fitting ex-gaussian distribution), for which it is better to have the original data for fitting and rely on the robustness of the statistics to account for outliers.

Still, we visualise how many trials would be rejected based on such thresholds

```{r preproc_rt, warning = FALSE, fig.align = "center"}
rt_thr <- 0.18

if (PLOTS){
# Number of outlier RT's per subject.
analysis_trials %>%
  group_by(ID) %>%
  filter(TrialType == "Real") %>% 
  filter((RT > 0 & RT <= rt_thr) | RT > (median(RT) + 5*mad(RT))) %>%
  summarise(nb_outliers = n()) %>% 
  ggplot(aes(x = ID, y = nb_outliers)) +
    geom_col() +
    xlab("Subject") + 
    ylab("Number of trials") +
    ggtitle("Number of trials to be discarded by RT") +
    get(plot_theme)() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
# Group level number of target events
# analysis_trials %>% 
#   filter(TrialType == "Real") %>% 
#   group_by(ID, Group, Task, Distractors) %>% 
#   summarise(n_trials = n()) %>% 
#   ungroup() %>% 
#   group_by(Group, Task, Distractors) %>% 
#   summarise(mean_trials = mean(n_trials), sd_trials = sd(n_trials))


# We'll keep RT == 0 trials since they are catch trials or misses.
# analysis_trials %>% filter((RT == 0) | (RT > rt_thr & RT < (median(RT) + 5*mad(RT)))) -> trials_ok
analysis_trials -> trials_ok
```


```{r Setup_contrasts}
grid.lvls <- expand.grid(Task = c('AttendFull', 'AttendLeft', 'AttendRight'),
                      Distractors = c('Absent', 'Present'),
                      Group = c('ADHD', 'Control'))

con_FvLR_adhd <- rbind("contrast" = c(0,0.5,0,0.5,0,-0.25,0,-0.25,0,-0.25,0,-0.25))
con_LvFR_adhd <- rbind("contrast" = c(0,-0.25,0,-0.25,0,0.5,0,0.5,0,-0.25,0,-0.25))
con_RvFL_adhd <- rbind("contrast" = c(0,-0.25,0,-0.25,0,-0.25,0,-0.25,0,0.5,0,0.5))
con_dstr_adhd <- rbind("contrast" = c(0,1/3,0,-1/3,0,1/3,0,-1/3,0,1/3,0,-1/3))
con_drAF_adhd <- contrasts21(con_FvLR_adhd * con_dstr_adhd)
con_drAL_adhd <- contrasts21(con_LvFR_adhd * con_dstr_adhd)
con_drAR_adhd <- contrasts21(con_RvFL_adhd * con_dstr_adhd)

con_FvLR_ctrl <- rbind("contrast" = c(0.5,0,0.5,0,-0.25,0,-0.25,0,-0.25,0,-0.25,0))
con_LvFR_ctrl <- rbind("contrast" = c(-0.25,0,-0.25,0,0.5,0,0.5,0,-0.25,0,-0.25,0))
con_RvFL_ctrl <- rbind("contrast" = c(-0.25,0,-0.25,0,-0.25,0,-0.25,0,0.5,0,0.5,0))
con_dstr_ctrl <- rbind("contrast" = c(1/3,0,-1/3,0,1/3,0,-1/3,0,1/3,0,-1/3,0))
con_drAF_ctrl <- contrasts21(con_FvLR_ctrl * con_dstr_ctrl)
con_drAL_ctrl <- contrasts21(con_LvFR_ctrl * con_dstr_ctrl)
con_drAR_ctrl <- contrasts21(con_RvFL_ctrl * con_dstr_ctrl)

con_drAF_CvA <- contrasts21(con_drAF_adhd * -1 + con_drAF_ctrl)
con_drAL_CvA <- contrasts21(con_drAL_adhd * -1 + con_drAL_ctrl)
con_drAR_CvA <- contrasts21(con_drAR_adhd * -1 + con_drAR_ctrl)
```



# Results
Results are given for each **task** x **distractor state** combination at the
group and single subject levels. We will look at:

Speed

* reaction time mean, estimated from ex-gaussian fit (mu of the gaussian part)
* reaction time variability, estimated from ex-gaussian fit (sigma of the gaussian part)
* reaction time slowing, estimated from long-tail of ex-gaussian fit (tau)
* (RT median and RT variance will be included for comparison, but not for principle analysis)

Accuracy

* hit rates
* false alarm rates
* distractor effects*

*Distractor effects are calculated in the following way:

$$\frac{HR_{distractors \ absent} - HR_{distractors \ present}}
{HR_{distractors \ absent} + HR_{distractors \ present}}$$


```{r calculate_behav_data, warning = FALSE}
# We'll create one data frame for each behavioral performance measure.

# ex-Gaussian mean, sd, and tau
exgauss.mx <- trials_ok %>%
  filter(TrialType == "Real", Resp == "Hit") %>%
  group_by(ID, dom_resp, Group, Task, Distractors) %>%
  do(data.frame(as.list(retimes::mexgauss(.$RT))))
exgauss.mx$Task <- droplevels(exgauss.mx$Task, exclude = "AttendNone")

exgauss.bt <- trials_ok %>%
  filter(TrialType == "Real", Resp == "Hit") %>%
  group_by(Group, dom_resp, ID, Task, Distractors) %>%
  summarise(timefit_out = list(data.frame(t(attr(retimes::timefit(RT),"par"))))) %>%
                   unnest(cols = c(timefit_out)) %>% ungroup
exgauss.bt$Task <- droplevels(exgauss.bt$Task, exclude = "AttendNone")

exgauss <- exgauss.mx
exgauss$Group <- relevel(exgauss$Group, ref = "Control")
exgauss$all_factors <- with(exgauss, interaction(Group, Distractors, Task))

if (PLOTS){
  qqnorm(exgauss$mu, main = "mu Normal Q-Q Plot")
  qqline(exgauss$mu)
  exgauss %>%
    ggplot(aes(mu, fill=Task)) +
      geom_density(alpha=.4) +
      facet_wrap(Group~Distractors, ncol=2) +
      get(plot_theme)()
  
  qqnorm(exgauss$sigma, main = "sigma Normal Q-Q Plot")
  qqline(exgauss$sigma)
  exgauss %>%
    ggplot(aes(sigma, fill=Task)) +
      geom_density(alpha=.4) +
      facet_wrap(Group~Distractors, ncol=2) +
      get(plot_theme)()
  
  qqnorm(exgauss$tau, main = "tau Normal Q-Q Plot")
  qqline(exgauss$tau)
  exgauss %>%
    ggplot(aes(tau, fill=Task)) +
      geom_density(alpha=.4) +
      facet_wrap(Group~Distractors, ncol=2) +
      get(plot_theme)()
}

# Reaction times (median).
trials_ok %>%
  filter(TrialType == "Real", Resp == "Hit") %>%
  group_by(ID, dom_resp, Group, Task, Distractors) %>%
  summarise(med_RT = median(RT)) ->
reaction_times


# Reaction time variance.
trials_ok %>%
  filter(TrialType == "Real", Resp == "Hit") %>%
  group_by(ID, dom_resp, Group, Task, Distractors) %>%
  summarise(var_RT = var(RT)) ->
rt_var


# Hit rates.
trials_ok %>%
  filter(TrialType == "Real") %>%
  group_by(ID, dom_resp, Group, Task, Distractors) %>%
  summarise(n_trials = n(),
            hit_rate = sum(Resp == "Hit") / n_trials) -> 
hit_rates
hit_rates$Task <- droplevels(hit_rates$Task, exclude = "AttendNone")
# hit_rates$sq_hr <- hit_rates$hit_rate ^ 2


# False alarms.
trials_ok %>%
  filter(TrialType == "Catch", Task != "AttendFull") %>%
  group_by(ID, dom_resp, Group, Task, Distractors) %>%
  summarise(n_trials = n(),
            fa_rate = sum(Resp == "False Alarm") / n_trials) -> 
fa_rates
fa_rates$Task <- droplevels(fa_rates$Task, exclude = "AttendFull")
# fa_rates$sq_far <- fa_rates$fa_rate ^ 2


# Distractor effect.
hit_rates %>%
  select(-n_trials) %>%
  spread(key = "Distractors", value = "hit_rate") %>%
  mutate(distractor_effect = (Absent - Present) / (Absent + Present)) %>%
  select(-Absent, -Present) -> 
distractor_effect
distractor_effect$Task <- droplevels(distractor_effect$Task, exclude = "AttendNone")
# distractor_effect$log_de <- log(distractor_effect$distractor_effect)


if (PLOTS){
# Normality test and visualise distros
qqnorm(reaction_times$med_RT, main = "Reaction time deviations Normal Q-Q Plot")
qqline(reaction_times$med_RT)
reaction_times %>%
  ggplot(aes(med_RT, fill=Task)) +
  geom_density(alpha=.4) +
  facet_wrap(Group~Distractors, ncol=2) +
  get(plot_theme)()
# Normality test and visualise distros
qqnorm(rt_var$var_RT, main = "RT variance deviations Normal Q-Q Plot")
qqline(rt_var$var_RT)
rt_var %>%
  ggplot(aes(var_RT, fill=Task)) +
  geom_density(alpha=.4) +
  facet_wrap(Group~Distractors, ncol=2) +
  get(plot_theme)()
# Normality test and visualise distros
qqnorm(hit_rates$hit_rate, main = "Hit rates deviations Normal Q-Q Plot")
qqline(hit_rates$hit_rate)
# qqnorm(hit_rates$sq_hr, main = "sq-transformed Hit rates deviations Normal Q-Q Plot")
# qqline(hit_rates$sq_hr)
hit_rates %>%
  ggplot(aes(hit_rate, fill=Task)) +
  geom_density(alpha=.4) +
  facet_wrap(Group~Distractors, ncol=2) +
  get(plot_theme)()
# Normality test and visualise distros
qqnorm(fa_rates$fa_rate, main = "False Alarm rates deviations Normal Q-Q Plot")
qqline(fa_rates$fa_rate)
# qqnorm(fa_rates$sq_far, main = "sq-transformed False Alarm rates deviations Normal Q-Q Plot")
# qqline(fa_rates$sq_far)
fa_rates %>%
  ggplot(aes(fa_rate, fill=Task)) +
  geom_density(alpha=.4) +
  facet_wrap(Group~Distractors, ncol=2) +
  get(plot_theme)()
# Normality test and visualise distros
qqnorm(distractor_effect$distractor_effect, main = "distractor_effect deviations Normal Q-Q Plot")
qqline(distractor_effect$distractor_effect)
# qqnorm(distractor_effect$log_de, main = "Log-transformed distractor_effect deviations Normal Q-Q Plot")
# qqline(distractor_effect$log_de)
distractor_effect %>%
  ggplot(aes(distractor_effect, fill=Task)) +
  geom_density(alpha=.4) +
  facet_wrap(~Group, ncol=2) +
  get(plot_theme)()
}
```


## MU

Ex-Gaussian stats of Reaction time - mu (gaussian central estimate)

```{r exgauss-mu, warning = FALSE, fig.align = "center"}
if (PLOTS){
# exgauss-mu, group level.
exgauss %>%
  ggplot(aes(x = Distractors, y = mu, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss mu (ms)") +
    ggtitle("RT ex-gauss mu, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "RTmu.svg"))

# RT ex-gauss mu, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

exgauss %>%
  group_by(Group, Task, Distractors) %>%
  summarise(exgmu_mean = mean(mu), exgmu_sem = sd(mu)/sqrt(n())) %>%
  ggplot(aes(x = Distractors, y = exgmu_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = exgmu_mean - exgmu_sem, ymax = exgmu_mean + exgmu_sem),
                  position = p_dodge, width = 0.25) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("Mean of RT ex-gauss mu (ms)") +
    ggtitle("RT ex-gauss mu, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# RT ex-gauss mu, single subject.
exgauss %>%
  ggplot(aes(x = Distractors, y = mu, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    facet_grid(Group ~ Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss mu (ms)") +
    ggtitle("RT ex-gauss mu, all task conditions, single subject") +
    get(plot_theme)() +
    theme(legend.position = "none")
}

# # Does response hand counter-balancing in CONTROL group affect exgauss MU?
with(exgauss,
  ks.test(exgauss[Group == "Control" & dom_resp == FALSE,]$mu,
          exgauss[Group == "Control" & dom_resp == TRUE,]$mu))
```


### Statistics for RT ex-gauss mu

```{r rt_exgauss_mu_stats, warning = FALSE, fig.align = "center"}
# Mixed 3-way ANOVA.
exgmu_stats <- ezANOVA(exgauss, dv = .(mu),
                    wid = .(ID),
                    within = .(Task, Distractors),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(exgmu_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(exgmu_stats, digits = 3)
}

# mu by lmer
mu_lmer <- lmer(mu ~ Group*Distractors*Task + (1|Distractors:ID) + (1|Task:ID) + (1|ID), data = exgauss.mx)
if (DIAGNOSTICS){
  summary(mu_lmer, digits = 3)
  plot_model(mu_lmer, type = "diag")[[4]]
}
```



### Constrasts for exgauss mu

__MU by LMM - joint tests and facet line plot of interactions__

```{r exgmu_CONTRAST, warning = FALSE, fig.align = "center"}
# Hit rate by lmer - joint tests and facet line plot of interactions
joint_tests(mu_lmer)
joint_tests(mu_lmer, by = "Group")
joint_tests(mu_lmer, by = c("Distractors", "Task"))
joint_tests(mu_lmer, by = "Distractors")
joint_tests(mu_lmer, by = c("Task", "Group"))
joint_tests(mu_lmer, by = "Task")
joint_tests(mu_lmer, by = c("Distractors", "Group"))


cbind(grid.lvls, mu = predict(mu_lmer, newdata = grid.lvls, re.form=NA)) %>%
  ggplot(aes(Distractors, mu, linetype=Task)) + geom_point() +
  geom_line(aes(group=Task),size=1) +
  facet_wrap(~Group) + theme_bw() + ggtitle("RT mu / mean") + ylab("RT mu")
# cbind(grid.lvls, mu = predict(mu_lmer, newdata = grid.lvls, re.form=NA)) %>%
#   ggplot(aes(Distractors, mu, linetype=Group)) + geom_point() +
#   geom_line(aes(group=Group),size=1) +
#   facet_wrap(~Task) + theme_bw() + ggtitle("RT mu / mean") + ylab("RT mu")
```

__Contrasts performed on the LMM of spread levels (all x all interaction)__

```{r}
# Contrasts
xgmu_contr <- lmer(mu ~ all_factors + (1|ID), data = exgauss)
# summary(xgmu_contr)

levels(exgauss$all_factors)

# "main effect" of task within ADHD
cat("TEST CONTRAST: FvLR_adhd", con_FvLR_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_FvLR_adhd)), test = Ftest())
cat("TEST CONTRAST: LvFR_adhd", con_LvFR_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_LvFR_adhd)), test = Ftest())
cat("TEST CONTRAST: RvFL_adhd", con_RvFL_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_RvFL_adhd)), test = Ftest())

# "main effect" of distractor within ADHD
cat("TEST CONTRAST: dstr_adhd", con_dstr_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_dstr_adhd)), test = Ftest())

# Interaction of distractor and task levels in ADHD
cat("TEST CONTRAST: drAF_adhd", con_drAF_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAF_adhd)), test = Ftest())
cat("TEST CONTRAST: drAL_adhd", con_drAL_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAL_adhd)), test = Ftest())
cat("TEST CONTRAST: drAR_adhd", con_drAR_adhd)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAR_adhd)), test = Ftest())

# "main effect" of task within CTRL
cat("TEST CONTRAST: FvLR_ctrl", con_FvLR_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_FvLR_ctrl)), test = Ftest())
cat("TEST CONTRAST: LvFR_ctrl", con_LvFR_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_LvFR_ctrl)), test = Ftest())
cat("TEST CONTRAST: RvFL_ctrl", con_RvFL_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_RvFL_ctrl)), test = Ftest())

# "main effect" of distractor within CTRL
cat("TEST CONTRAST: dstr_ctrl", con_dstr_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_dstr_ctrl)), test = Ftest())

# Interaction of distractor and task levels in CTRL
cat("TEST CONTRAST: drAF_ctrl", con_drAF_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAF_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl", con_drAL_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAL_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl", con_drAR_ctrl)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAR_ctrl)), test = Ftest())

# Interaction of distractor and task levels between ADHD & CTRL
cat("TEST CONTRAST: drAF_ctrl V ADHD", con_drAF_CvA)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAF_CvA)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl V ADHD", con_drAL_CvA)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAL_CvA)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl V ADHD", con_drAR_CvA)
summary(glht(xgmu_contr, linfct = mcp(all_factors = con_drAR_CvA)), test = Ftest())

```



## SIGMA

Ex-Gaussian stats of Reaction time - sigma (gaussian dispersion)

```{r exgauss-sigma, warning = FALSE, fig.align = "center"}
if (PLOTS){
# exgauss-sigma, group level.
exgauss %>%
  ggplot(aes(x = Distractors, y = sigma, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss sigma (ms)") +
    ggtitle("RT ex-gauss sigma, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "RTsigma.svg"))

# RT ex-gauss sigma, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

exgauss %>%
  group_by(Group, Task, Distractors) %>%
  summarise(exgsigma_mean = mean(sigma), exgsigma_sem = sd(sigma)/sqrt(n())) %>%
  ggplot(aes(x = Distractors, y = exgsigma_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = exgsigma_mean - exgsigma_sem, ymax = exgsigma_mean + exgsigma_sem),
                  position = p_dodge, width = 0.25) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("Mean of RT ex-gauss sigma (ms)") +
    ggtitle("RT ex-gauss sigma, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# RT ex-gauss sigma, single subject.
exgauss %>%
  ggplot(aes(x = Distractors, y = sigma, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    facet_grid(Group ~ Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss sigma (ms)") +
    ggtitle("RT ex-gauss sigma, all task conditions, single subject") +
    get(plot_theme)() +
    theme(legend.position = "none")
}

# # Does response hand counter-balancing in CONTROL group affect exgauss SIGMA?
with(exgauss,
  ks.test(exgauss[Group == "Control" & dom_resp == FALSE,]$sigma,
          exgauss[Group == "Control" & dom_resp == TRUE,]$sigma))
```


### Statistics for RTV - exgauss sigma:

```{r rt_exgauss_sigma_stats, warning = FALSE, fig.align = "center"}
# Mixed 3-way ANOVA.
exgsigma_stats <- ezANOVA(exgauss, dv = .(sigma),
                    wid = .(ID),
                    within = .(Task, Distractors),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(exgsigma_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(exgsigma_stats)
}

# sigma by lmer
sigma_lmer <- lmer(sigma ~ Group*Distractors*Task + (1|Distractors:ID) + (1|Task:ID) + (1|ID), data = exgauss.mx)
if (DIAGNOSTICS){
  summary(sigma_lmer)
  plot_model(sigma_lmer, type = "diag")[[4]]
}
```



### Constrasts for exgauss sigma

__SIGMA by LMM - joint tests and facet line plot of interactions__

```{r exgsigma_CONTRAST, warning = FALSE, fig.align = "center"}
# Hit rate by lmer - joint tests and facet line plot of interactions
joint_tests(sigma_lmer)
joint_tests(sigma_lmer, by = "Group")
joint_tests(sigma_lmer, by = c("Distractors", "Task"))
joint_tests(sigma_lmer, by = "Distractors")
joint_tests(sigma_lmer, by = c("Task", "Group"))
joint_tests(sigma_lmer, by = "Task")
joint_tests(sigma_lmer, by = c("Distractors", "Group"))


cbind(grid.lvls, sigma = predict(sigma_lmer, newdata = grid.lvls, re.form=NA)) %>%
  ggplot(aes(Distractors, sigma, linetype=Task)) + geom_point() +
  geom_line(aes(group=Task),size=1) +
  facet_wrap(~Group) + theme_bw() + ggtitle("RT sigma / variability") + ylab("RT sigma")
# cbind(grid.lvls, sigma = predict(sigma_lmer, newdata = grid.lvls, re.form=NA)) %>%
#   ggplot(aes(Distractors, sigma, linetype=Group)) + geom_point() +
#   geom_line(aes(group=Group),size=1) +
#   facet_wrap(~Task) + theme_bw() + ggtitle("RT sigma / variability") + ylab("RT sigma")
```

__Contrasts performed on the LMM of spread levels (all x all interaction)__

```{r}
# Contrasts
xgsigma_contr <- lmer(sigma ~ all_factors + (1|ID), data = exgauss)
# summary(xgsigma_contr)

# Repeat this for readability of contrasts
levels(exgauss$all_factors)

# "main effect" of task within ADHD
cat("TEST CONTRAST: FvLR_adhd", con_FvLR_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_FvLR_adhd)), test = Ftest())
cat("TEST CONTRAST: LvFR_adhd", con_LvFR_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_LvFR_adhd)), test = Ftest())
cat("TEST CONTRAST: RvFL_adhd", con_RvFL_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_RvFL_adhd)), test = Ftest())

# "main effect" of distractor within ADHD
cat("TEST CONTRAST: dstr_adhd", con_dstr_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_dstr_adhd)), test = Ftest())

# Interaction of distractor and task levels in ADHD
cat("TEST CONTRAST: drAF_adhd", con_drAF_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAF_adhd)), test = Ftest())
cat("TEST CONTRAST: drAL_adhd", con_drAL_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAL_adhd)), test = Ftest())
cat("TEST CONTRAST: drAR_adhd", con_drAR_adhd)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAR_adhd)), test = Ftest())

# "main effect" of task within CTRL
cat("TEST CONTRAST: FvLR_ctrl", con_FvLR_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_FvLR_ctrl)), test = Ftest())
cat("TEST CONTRAST: LvFR_ctrl", con_LvFR_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_LvFR_ctrl)), test = Ftest())
cat("TEST CONTRAST: RvFL_ctrl", con_RvFL_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_RvFL_ctrl)), test = Ftest())

# "main effect" of distractor within CTRL
cat("TEST CONTRAST: dstr_ctrl", con_dstr_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_dstr_ctrl)), test = Ftest())

# Interaction of distractor and task levels in CTRL
cat("TEST CONTRAST: drAF_ctrl", con_drAF_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAF_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl", con_drAL_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAL_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl", con_drAR_ctrl)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAR_ctrl)), test = Ftest())

# Interaction of distractor and task levels between ADHD & CTRL
cat("TEST CONTRAST: drAF_ctrl V ADHD", con_drAF_CvA)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAF_CvA)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl V ADHD", con_drAL_CvA)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAL_CvA)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl V ADHD", con_drAR_CvA)
summary(glht(xgsigma_contr, linfct = mcp(all_factors = con_drAR_CvA)), test = Ftest())
```



## TAU

Ex-Gaussian stats of Reaction time - tau (exponential tail)

```{r exgauss-tau, warning = FALSE, fig.align = "center"}
if (PLOTS){
# exgauss-tau, group level.
exgauss %>%
  ggplot(aes(x = Distractors, y = tau, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss tau (ms)") +
    ggtitle("RT ex-gauss tau, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "RTtau.svg"))

# RT ex-gauss tau, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

exgauss %>%
  group_by(Group, Task, Distractors) %>%
  summarise(exgtau_mean = mean(tau), exgtau_sem = sd(tau)/sqrt(n())) %>%
  ggplot(aes(x = Distractors, y = exgtau_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = exgtau_mean - exgtau_sem, ymax = exgtau_mean + exgtau_sem),
                  position = p_dodge, width = 0.25) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("Mean of RT ex-gauss tau (ms)") +
    ggtitle("RT ex-gauss tau, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# RT ex-gauss tau, single subject.
exgauss %>%
  ggplot(aes(x = Distractors, y = tau, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    facet_grid(Group ~ Task) +
    xlab("Distractor state") +
    ylab("RT ex-gauss tau (ms)") +
    ggtitle("RT ex-gauss tau, all task conditions, single subject") +
    get(plot_theme)() +
    theme(legend.position = "none")
}

# # Does response hand counter-balancing in CONTROL group affect exgauss TAU?
with(exgauss,
  ks.test(exgauss[Group == "Control" & dom_resp == FALSE,]$tau,
          exgauss[Group == "Control" & dom_resp == TRUE,]$tau))
```


### Statistics for RT ex-gauss tau:

```{r rt_exgauss_tau_stats, warning = FALSE, fig.align = "center"}
# Mixed 3-way ANOVA.
exgtau_stats <- ezANOVA(exgauss, dv = .(tau),
                    wid = .(ID),
                    within = .(Task, Distractors),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(exgtau_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(exgtau_stats)
}

# tau by lmer
tau_lmer <- lmer(tau ~ Group*Distractors*Task + (1|Distractors:ID) + (1|Task:ID) + (1|ID), data = exgauss.mx)
if (DIAGNOSTICS){
  summary(tau_lmer)
  plot_model(tau_lmer, type = "diag")[[4]]
}
```



### Constrasts for exgauss tau

__TAU by LMM - joint tests and facet line plot of interactions__

```{r exgtau_CONTRAST, warning = FALSE, fig.align = "center"}
# Hit rate by lmer - joint tests and facet line plot of interactions
joint_tests(tau_lmer)
joint_tests(tau_lmer, by = "Group")
joint_tests(tau_lmer, by = c("Distractors", "Task"))
joint_tests(tau_lmer, by = "Distractors")
joint_tests(tau_lmer, by = c("Task", "Group"))
joint_tests(tau_lmer, by = "Task")
joint_tests(tau_lmer, by = c("Distractors", "Group"))


cbind(grid.lvls, tau = predict(tau_lmer, newdata = grid.lvls, re.form=NA)) %>%
  ggplot(aes(Distractors, tau, linetype=Task)) + geom_point() +
  geom_line(aes(group=Task),size=1) +
  facet_wrap(~Group) + theme_bw() + ggtitle("RT tau / slowing") + ylab("RT tau")
# cbind(grid.lvls, tau = predict(tau_lmer, newdata = grid.lvls, re.form=NA)) %>%
#   ggplot(aes(Distractors, tau, linetype=Group)) + geom_point() +
#   geom_line(aes(group=Group),size=1) +
#   facet_wrap(~Task) + theme_bw() + ggtitle("RT tau / slowing") + ylab("RT tau")
```

__Contrasts performed on the LMM of spread levels (all x all interaction)__

```{r}
# Contrasts
xgtau_contr <- lmer(tau ~ all_factors + (1|ID), data = exgauss)
# summary(xgtau_contr)

# Repeat this for readability of contrasts
levels(exgauss$all_factors)

# "main effect" of task within ADHD
cat("TEST CONTRAST: FvLR_adhd", con_FvLR_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_FvLR_adhd)), test = Ftest())
cat("TEST CONTRAST: LvFR_adhd", con_LvFR_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_LvFR_adhd)), test = Ftest())
cat("TEST CONTRAST: RvFL_adhd", con_RvFL_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_RvFL_adhd)), test = Ftest())

# "main effect" of distractor within ADHD
cat("TEST CONTRAST: dstr_adhd", con_dstr_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_dstr_adhd)), test = Ftest())

# Interaction of distractor and task levels in ADHD
cat("TEST CONTRAST: drAF_adhd", con_drAF_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAF_adhd)), test = Ftest())
cat("TEST CONTRAST: drAL_adhd", con_drAL_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAL_adhd)), test = Ftest())
cat("TEST CONTRAST: drAR_adhd", con_drAR_adhd)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAR_adhd)), test = Ftest())

# "main effect" of task within CTRL
cat("TEST CONTRAST: FvLR_ctrl", con_FvLR_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_FvLR_ctrl)), test = Ftest())
cat("TEST CONTRAST: LvFR_ctrl", con_LvFR_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_LvFR_ctrl)), test = Ftest())
cat("TEST CONTRAST: RvFL_ctrl", con_RvFL_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_RvFL_ctrl)), test = Ftest())

# "main effect" of distractor within CTRL
cat("TEST CONTRAST: dstr_ctrl", con_dstr_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_dstr_ctrl)), test = Ftest())

# Interaction of distractor and task levels in CTRL
cat("TEST CONTRAST: drAF_ctrl", con_drAF_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAF_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl", con_drAL_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAL_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl", con_drAR_ctrl)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAR_ctrl)), test = Ftest())

# Interaction of distractor and task levels between ADHD & CTRL
cat("TEST CONTRAST: drAF_ctrl V ADHD", con_drAF_CvA)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAF_CvA)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl V ADHD", con_drAL_CvA)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAL_CvA)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl V ADHD", con_drAR_CvA)
summary(glht(xgtau_contr, linfct = mcp(all_factors = con_drAR_CvA)), test = Ftest())
```




<!-- ## RTs -->

<!-- Reaction times -->

<!-- ```{r reaction_times, warning = FALSE, fig.align = "center"} -->
<!-- # Reaction times, group level. -->
<!-- reaction_times %>% -->
<!--   ggplot(aes(x = Distractors, y = med_RT, linetype = Group, color = Group)) + -->
<!--     geom_boxplot(outlier.alpha = 0, alpha = 1/5) + -->
<!--     geom_point(position = position_jitterdodge(jitter.width = 0.2)) + -->
<!--     # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) + -->
<!--     facet_wrap(~Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Median reaction time (ms)") + -->
<!--     ggtitle("Reaction times, all task conditions, group level") + -->
<!--     get(plot_theme)() -->
<!-- if (SAVE) -->
<!--   ggsave(paste0(odir, "RTmed.svg")) -->

<!-- # Reaction times, group level, barchart with SEM. -->
<!-- p_dodge <- position_dodge(width = 0.9) -->

<!-- reaction_times %>% -->
<!--   group_by(Group, Task, Distractors) %>% -->
<!--   summarise(RT_mean = mean(med_RT), RT_sem = sd(med_RT)/sqrt(n())) %>% -->
<!--   ggplot(aes(x = Distractors, y = RT_mean, fill = Group)) + -->
<!--     geom_col(position = p_dodge) + -->
<!--     geom_errorbar(aes(ymin = RT_mean - RT_sem, ymax = RT_mean + RT_sem), -->
<!--                   position = p_dodge, width = 0.25) + -->
<!--     facet_wrap(~Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Mean of median reaction times (ms)") + -->
<!--     ggtitle("Reaction times, all task conditions, group level, +/- SEM") + -->
<!--     scale_fill_brewer(palette = "Greys") + -->
<!--     get(plot_theme)() -->

<!-- # Reaction times, single subject. -->
<!-- reaction_times %>% -->
<!--   ggplot(aes(x = Distractors, y = med_RT, color = dom_resp)) + -->
<!--     geom_line(aes(group = ID)) + -->
<!--     geom_point() + -->
<!--     facet_grid(Group ~ Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Median reaction time (ms)") + -->
<!--     ggtitle("Reaction times, all task conditions, single subject") + -->
<!--     get(plot_theme)() + -->
<!--     theme(legend.position = "none") -->

<!-- # Does response hand counter-balancing in CONTROL group affect reaction time? -->
<!-- with(reaction_times, -->
<!--   ks.test(reaction_times[Group == "Control" & dom_resp == FALSE,]$med_RT, -->
<!--           reaction_times[Group == "Control" & dom_resp == TRUE,]$med_RT)) -->

<!-- ``` -->


<!-- Statistics for reaction times: -->

<!-- ```{r reaction_times_stats, warning = FALSE, fig.align = "center"} -->
<!-- # Mixed 3-way ANOVA. -->
<!-- rt_stats <- ezANOVA(reaction_times, dv = .(med_RT), -->
<!--                     wid = .(ID), -->
<!--                     within = .(Task, Distractors), -->
<!--                     between = .(Group), -->
<!--                     type = 3, detailed = FALSE, return_aov = TRUE) -->
<!-- ezanova_residuals <- purrr::map(rt_stats$aov, residuals) -->
<!-- ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest -->
<!-- hist(ezanova_residuals_tbl$value) -->
<!-- shapiro.test(ezanova_residuals_tbl$value) -->
<!-- print(rt_stats) -->
<!-- ``` -->


<!-- ## RT variability -->

<!-- Reaction time variability -->

<!-- ```{r RTV, warning = FALSE, fig.align = "center"} -->
<!-- # RTV, group level. -->
<!-- rt_var %>% -->
<!--   ggplot(aes(x = Distractors, y = var_RT, linetype = Group, color = Group)) + -->
<!--     geom_boxplot(outlier.alpha = 0, alpha = 1/5) + -->
<!--     geom_point(position = position_jitterdodge(jitter.width = 0.2)) + -->
<!--     # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) + -->
<!--     facet_wrap(~Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Reaction time variance (ms)") + -->
<!--     ggtitle("Reaction time variance, all task conditions, group level") + -->
<!--     get(plot_theme)() -->
<!-- if (SAVE) -->
<!--   ggsave(paste0(odir, "RTV.svg")) -->

<!-- # Reaction times, group level, barchart with SEM. -->
<!-- p_dodge <- position_dodge(width = 0.9) -->

<!-- rt_var %>% -->
<!--   group_by(Group, Task, Distractors) %>% -->
<!--   summarise(RTV_mean = mean(var_RT), RTV_sem = sd(var_RT)/sqrt(n())) %>% -->
<!--   ggplot(aes(x = Distractors, y = RTV_mean, fill = Group)) + -->
<!--     geom_col(position = p_dodge) + -->
<!--     geom_errorbar(aes(ymin = RTV_mean - RTV_sem, ymax = RTV_mean + RTV_sem), -->
<!--                   position = p_dodge, width = 0.25) + -->
<!--     facet_wrap(~Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Mean of reaction time variance (ms)") + -->
<!--     ggtitle("Reaction times, all task conditions, group level, +/- SEM") + -->
<!--     scale_fill_brewer(palette = "Greys") + -->
<!--     get(plot_theme)() -->

<!-- # Reaction times, single subject. -->
<!-- rt_var %>% -->
<!--   ggplot(aes(x = Distractors, y = var_RT, color = dom_resp)) + -->
<!--     geom_line(aes(group = ID)) + -->
<!--     geom_point() + -->
<!--     facet_grid(Group ~ Task) + -->
<!--     xlab("Distractor state") + -->
<!--     ylab("Reaction time variance (ms)") + -->
<!--     ggtitle("Reaction time variance, all task conditions, single subject") + -->
<!--     get(plot_theme)() + -->
<!--     theme(legend.position = "none") -->

<!-- # Does response hand counter-balancing in CONTROL group affect reaction time var? -->
<!-- with(rt_var, -->
<!--   ks.test(rt_var[Group == "Control" & dom_resp == FALSE,]$var_RT, -->
<!--           rt_var[Group == "Control" & dom_resp == TRUE,]$var_RT)) -->
<!-- ``` -->


<!-- Statistics for RTV: -->

<!-- ```{r RTV_stats, warning = FALSE, fig.align = "center"} -->
<!-- # Mixed 3-way ANOVA. -->
<!-- rtv_stats <- ezANOVA(rt_var, dv = .(var_RT), -->
<!--                     wid = .(ID), -->
<!--                     within = .(Task, Distractors), -->
<!--                     between = .(Group), -->
<!--                     type = 3, detailed = FALSE, return_aov = TRUE) -->
<!-- ezanova_residuals <- purrr::map(rtv_stats$aov, residuals) -->
<!-- ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest -->
<!-- hist(ezanova_residuals_tbl$value) -->
<!-- shapiro.test(ezanova_residuals_tbl$value) -->
<!-- print(rtv_stats) -->

<!-- ``` -->


## Hit rates

```{r hit_rates, warning = FALSE, fig.align = "center"}
if (PLOTS){
# Hit rates, group level.
hit_rates %>%
  ggplot(aes(x = Distractors, y = hit_rate, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("Hit rate") +
    ggtitle("Hit rates, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "HITS.svg"))

# Hit rates, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

hit_rates %>%
  group_by(Group, Task, Distractors) %>%
  summarise(HR_mean = mean(hit_rate), HR_sem = sd(hit_rate)/sqrt(n())) %>%
  ggplot(aes(x = Distractors, y = HR_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = HR_mean - HR_sem, ymax = HR_mean + HR_sem),
                  position = p_dodge, width = 0.25) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("Hit rate") +
    ggtitle("Hit rates, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# Hit rates, single subject.
hit_rates %>%
  ggplot(aes(x = Distractors, y = hit_rate, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    scale_y_continuous(labels = scales::percent) +
    facet_grid(Group ~ Task) +
    xlab("Distractor state") +
    ylab("Hit rate") +
    ggtitle("Hit rates, all task conditions, single subject (color = response hand dominant)") +
    get(plot_theme)() +
    theme(legend.position = "none")
}

# Does response hand counter-balancing in CONTROL group affect hit rates?
with(hit_rates,
  ks.test(hit_rates[Group == "Control" & dom_resp == FALSE,]$hit_rate,
          hit_rates[Group == "Control" & dom_resp == TRUE,]$hit_rate))
```

### Statistics for hit rates

```{r hit_rates_stats, warning = FALSE, fig.align = "center"}
# Mixed 3-way ANOVA.
hr_stats <- ezANOVA(hit_rates, dv = .(hit_rate),
                    wid = .(ID),
                    within = .(Task, Distractors),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(hr_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(hr_stats)
}

# Hit rate by lmer
hr_lmer <- lmer(hit_rate ~ Group*Distractors*Task + (1|Distractors:ID) + (1|Task:ID) + (1|ID), data = hit_rates)
if (DIAGNOSTICS){
  summary(hr_lmer)
  plot_model(hr_lmer, type = "diag")[[4]]
}
```

### Constrasts for Hit Rates

__Hit rate by LMM - joint tests and facet line plot of interactions__

```{r hit_rates_CONTRAST, warning = FALSE, fig.align = "center"}

joint_tests(hr_lmer)
joint_tests(hr_lmer, by = "Group")
joint_tests(hr_lmer, by = c("Distractors", "Task"))
joint_tests(hr_lmer, by = "Distractors")
joint_tests(hr_lmer, by = c("Task", "Group"))
joint_tests(hr_lmer, by = "Task")
joint_tests(hr_lmer, by = c("Distractors", "Group"))

cbind(grid.lvls, hr = predict(hr_lmer, newdata = grid.lvls, re.form=NA)) %>%
  ggplot(aes(Distractors, hr, linetype=Task)) + geom_point() +
  geom_line(aes(group=Task),size=1) +
  facet_wrap(~Group) + theme_bw() + ggtitle("HR values") + ylab("Hit Rate")
# cbind(grid.lvls, hr = predict(hr_lmer, newdata = grid.lvls, re.form=NA)) %>%
#   ggplot(aes(Distractors, hr, linetype=Group)) + geom_point() +
#   geom_line(aes(group=Group),size=1) +
#   facet_wrap(~Task) + theme_bw() + ggtitle("HR values") + ylab("Hit Rate")

```


__Contrasts performed on the LMM of spread levels (all x all interaction)__
```{r}
# Contrasts
hit_rates$Group <- relevel(hit_rates$Group, ref = "Control")
hit_rates$all_factors <- with(hit_rates, interaction(Group, Distractors, Task))
hr_contr <- lmer(hit_rate ~ all_factors + (1|ID), data = hit_rates)
# summary(hr_contr)

levels(hit_rates$all_factors)

# "main effect" of task within ADHD
cat("TEST CONTRAST: FvLR_adhd", con_FvLR_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_FvLR_adhd)), test = Ftest())
cat("TEST CONTRAST: LvFR_adhd", con_LvFR_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_LvFR_adhd)), test = Ftest())
cat("TEST CONTRAST: RvFL_adhd", con_RvFL_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_RvFL_adhd)), test = Ftest())

# "main effect" of distractor within ADHD
cat("TEST CONTRAST: dstr_adhd", con_dstr_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_dstr_adhd)), test = Ftest())

# Interaction of distractor and task levels in ADHD
cat("TEST CONTRAST: drAF_adhd", con_drAF_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAF_adhd)), test = Ftest())
cat("TEST CONTRAST: drAL_adhd", con_drAL_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAL_adhd)), test = Ftest())
cat("TEST CONTRAST: drAR_adhd", con_drAR_adhd)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAR_adhd)), test = Ftest())

# "main effect" of task within CTRL
cat("TEST CONTRAST: FvLR_ctrl", con_FvLR_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_FvLR_ctrl)), test = Ftest())
cat("TEST CONTRAST: LvFR_ctrl", con_LvFR_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_LvFR_ctrl)), test = Ftest())
cat("TEST CONTRAST: RvFL_ctrl", con_RvFL_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_RvFL_ctrl)), test = Ftest())

# "main effect" of distractor within CTRL
cat("TEST CONTRAST: dstr_ctrl", con_dstr_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_dstr_ctrl)), test = Ftest())

# Interaction of distractor and task levels in CTRL
cat("TEST CONTRAST: drAF_ctrl", con_drAF_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAF_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl", con_drAL_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAL_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl", con_drAR_ctrl)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAR_ctrl)), test = Ftest())

# Interaction of distractor and task levels between ADHD & CTRL
cat("TEST CONTRAST: drAF_ctrl V ADHD", con_drAF_CvA)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAF_CvA)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl V ADHD", con_drAL_CvA)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAL_CvA)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl V ADHD", con_drAR_CvA)
summary(glht(hr_contr, linfct = mcp(all_factors = con_drAR_CvA)), test = Ftest())

# # The PALOMÄKI APPROACH
# main_effect_GRUP <- rbind("Main effect CTRLvADHD" = c(1,-1,1,-1,1,-1,1,-1,1,-1,1,-1))
# main_effect_DSTR <- rbind("Main effect of Distractor" = c(-1,-1,1,1,-1,-1,1,1,-1,-1,1,1))
# full_vs_left <- rbind("Attend FULL vs LEFT" = c(1,1,1,1,-1,-1,-1,-1,0,0,0,0))
# full_vs_right <- rbind("Attend FULL vs RIGHT" = c(1,1,1,1,0,0,0,0,-1,-1,-1,-1))
#
# #Create matrix contrast for the MAIN EFFEFCT of "TASK":
# main_effect_TASK <- rbind(full_vs_left, full_vs_right)
#
# #take the PRODUCT of the main effect contrasts as a matrix
# interaction_DSTR.TASK <- rbind(main_effect_DSTR*full_vs_left,
#                                main_effect_DSTR*full_vs_right)
# interaction_GRUP.DSTR.TASK <- rbind(main_effect_GRUP*main_effect_DSTR*full_vs_left,
#                                     main_effect_GRUP*main_effect_DSTR*full_vs_right)
#
# #Perform contrast analyses. Compare the output against the original type-3 SS table of the 2x3 ANOVA. The numbers are identical.
# #MAIN EFFECT OF GROUP:
# summary(glht(hr_contr, linfct = mcp(all_factors = contrasts21(main_effect_GRUP))))
# #MAIN EFFECT OF DISTRACTOR:
# summary(glht(hr_contr, linfct = mcp(all_factors = contrasts21(main_effect_DSTR))))
# #MAIN EFFECT OF TASK:
# summary(glht(hr_contr, linfct = mcp(all_factors = contrasts21(main_effect_TASK))))
# #INTERACTION DISTRACTOR*TASK:
# summary(glht(hr_contr, linfct = mcp(all_factors = contrasts21(interaction_DSTR.TASK))))
# #INTERACTION GROUP*DISTRACTOR*TASK:
# summary(glht(hr_contr, linfct = mcp(all_factors = contrasts21(interaction_GRUP.DSTR.TASK))))
```



## False alarms

```{r fa_rates, warning = FALSE, fig.align = "center"}
if (PLOTS){
# False alarm rates, group level.
fa_rates %>%
  ggplot(aes(x = Distractors, y = fa_rate, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("False alarm rate") +
    ggtitle("False alarm rates, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "FArate.svg"))

# False alarm rates, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

fa_rates %>%
  group_by(Group, Task, Distractors) %>%
  summarise(FA_mean = mean(fa_rate), FA_sem = sd(fa_rate)/sqrt(n())) %>%
  ggplot(aes(x = Distractors, y = FA_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = FA_mean - FA_sem, ymax = FA_mean + FA_sem),
                  position = p_dodge, width = 0.25) +
    scale_y_continuous(labels = scales::percent) +
    facet_wrap(~Task) +
    xlab("Distractor state") +
    ylab("False alarm rate") +
    ggtitle("False alarm rates, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# False alarm rates, single subject.
fa_rates %>%
  ggplot(aes(x = Distractors, y = fa_rate, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    scale_y_continuous(labels = scales::percent) +
    facet_grid(Group ~ Task) +
    xlab("Distractor state") +
    ylab("False alarm rate") +
    ggtitle("False alarm rates, all task conditions, single subject") +
    get(plot_theme)() +
    theme(legend.position = "none")
}

# Does response hand counter-balancing in CONTROL group affect FA rates?
with(fa_rates,
  ks.test(fa_rates[Group == "Control" & dom_resp == FALSE,]$fa_rate,
          fa_rates[Group == "Control" & dom_resp == TRUE,]$fa_rate))
```

### Statistics for false alarm rates:

```{r fa_rates_stats, warning = FALSE, fig.align = "center"}
# Mixed 3-way ANOVA.
fa_stats <- ezANOVA(fa_rates, dv = .(fa_rate),
                    wid = .(ID),
                    within = .(Task, Distractors),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(fa_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(fa_stats)
}

# False Alarm by lmer
fa_lmer <- lmer(fa_rate ~ Group*Distractors*Task + (1|Distractors:ID) + (1|Task:ID) + (1|ID), data = fa_rates)
if (DIAGNOSTICS){
  summary(fa_lmer)
  plot_model(fa_lmer, type = "diag")[[4]]
}
```


### Constrasts for False Alarms

__False Alarm by LMM - joint tests and facet line plot of interactions__

```{r false_alarm_CONTRAST, warning = FALSE, fig.align = "center"}

joint_tests(fa_lmer)
joint_tests(fa_lmer, by = "Group")
joint_tests(fa_lmer, by = c("Distractors", "Task"))
joint_tests(fa_lmer, by = "Distractors")
joint_tests(fa_lmer, by = c("Task", "Group"))
joint_tests(fa_lmer, by = "Task")
joint_tests(fa_lmer, by = c("Distractors", "Group"))

fa.grid.lvls <- expand.grid(Task = c('AttendLeft', 'AttendNone', 'AttendRight'),
                      Distractors = c('Absent', 'Present'),
                      Group = c('ADHD', 'Control'))

cbind(fa.grid.lvls, fa = predict(fa_lmer, newdata = fa.grid.lvls, re.form=NA)) %>%
  ggplot(aes(Distractors, fa, linetype=Task)) + geom_point() +
  geom_line(aes(group=Task),size=1) +
  facet_wrap(~Group) + theme_bw() + ggtitle("False Alarms") + ylab("False Alarms")
# cbind(fa.grid.lvls, fa = predict(fa_lmer, newdata = fa.grid.lvls, re.form=NA)) %>%
#   ggplot(aes(Distractors, fa, linetype=Group)) + geom_point() +
#   geom_line(aes(group=Group),size=1) +
#   facet_wrap(~Task) + theme_bw() + ggtitle("False Alarms") + ylab("False Alarms")

```


__Contrasts performed on the LMM of spread levels (all x all interaction)__
```{r}
# Contrasts
fa_rates$Group <- relevel(fa_rates$Group, ref = "Control")
fa_rates$all_factors <- with(fa_rates, interaction(Group, Distractors, Task))
fa_contr <- lmer(fa_rate ~ all_factors + (1|ID), data = fa_rates)
# summary(fa_contr)

levels(fa_rates$all_factors)

con_NvLR_adhd <- rbind("NvLR_adhd" = c(0,-0.25,0,-0.25,0,0.5,0,0.5,0,-0.25,0,-0.25))
con_LvNR_adhd <- rbind("LvNR_adhd" = c(0,0.5,0,0.5,0,-0.25,0,-0.25,0,-0.25,0,-0.25))
con_RvNL_adhd <- rbind("RvNL_adhd" = c(0,-0.25,0,-0.25,0,-0.25,0,-0.25,0,0.5,0,0.5))
con_dstr_adhd <- rbind("dstr_adhd" = c(0,1/3,0,-1/3,0,1/3,0,-1/3,0,1/3,0,-1/3))
con_drAN_adhd <- rbind("drAN_adhd" = contrasts21(con_NvLR_adhd * con_dstr_adhd))
con_drAL_adhd <- rbind("drAL_adhd" = contrasts21(con_LvNR_adhd * con_dstr_adhd))
con_drAR_adhd <- rbind("drAR_adhd" = contrasts21(con_RvNL_adhd * con_dstr_adhd))

con_NvLR_ctrl <- rbind("NvLR_ctrl" = c(-0.25,0,-0.25,0,0.5,0,0.5,0,-0.25,0,-0.25,0))
con_LvNR_ctrl <- rbind("LvNR_ctrl" = c(0.5,0,0.5,0,-0.25,0,-0.25,0,-0.25,0,-0.25,0))
con_RvNL_ctrl <- rbind("RvNL_ctrl" = c(-0.25,0,-0.25,0,-0.25,0,-0.25,0,0.5,0,0.5,0))
con_dstr_ctrl <- rbind("dstr_ctrl" = c(1/3,0,-1/3,0,1/3,0,-1/3,0,1/3,0,-1/3,0))
con_drAN_ctrl <- rbind("drAN_ctrl" = contrasts21(con_NvLR_ctrl * con_dstr_ctrl))
con_drAL_ctrl <- rbind("drAL_ctrl" = contrasts21(con_LvNR_ctrl * con_dstr_ctrl))
con_drAR_ctrl <- rbind("drAR_ctrl" = contrasts21(con_RvNL_ctrl * con_dstr_ctrl))

con_drAN_CvA <- rbind("drAN_CvA" = contrasts21(con_drAN_adhd * -1 + con_drAN_ctrl))
con_drAL_CvA <- rbind("drAL_CvA" = contrasts21(con_drAL_adhd * -1 + con_drAL_ctrl))
con_drAR_CvA <- rbind("drAR_CvA" = contrasts21(con_drAR_adhd * -1 + con_drAR_ctrl))

# "main effect" of task within ADHD
cat("TEST CONTRAST: NvLR_adhd", con_NvLR_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_NvLR_adhd)), test = Ftest())
cat("TEST CONTRAST: LvNR_adhd", con_LvNR_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_LvNR_adhd)), test = Ftest())
cat("TEST CONTRAST: RvNL_adhd", con_RvNL_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_RvNL_adhd)), test = Ftest())

# "main effect" of distractor within ADHD
cat("TEST CONTRAST: dstr_adhd", con_dstr_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_dstr_adhd)), test = Ftest())

# Interaction of distractor and task levels in ADHD
cat("TEST CONTRAST: drAN_adhd", con_drAN_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAN_adhd)), test = Ftest())
cat("TEST CONTRAST: drAL_adhd", con_drAL_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAL_adhd)), test = Ftest())
cat("TEST CONTRAST: drAR_adhd", con_drAR_adhd)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAR_adhd)), test = Ftest())

# "main effect" of task within CTRL
cat("TEST CONTRAST: NvLR_ctrl", con_NvLR_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_NvLR_ctrl)), test = Ftest())
cat("TEST CONTRAST: LvNR_ctrl", con_LvNR_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_LvNR_ctrl)), test = Ftest())
cat("TEST CONTRAST: RvNL_ctrl", con_RvNL_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_RvNL_ctrl)), test = Ftest())

# "main effect" of distractor within CTRL
cat("TEST CONTRAST: dstr_ctrl", con_dstr_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_dstr_ctrl)), test = Ftest())

# Interaction of distractor and task levels in CTRL
cat("TEST CONTRAST: drAN_ctrl", con_drAN_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAN_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl", con_drAL_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAL_ctrl)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl", con_drAR_ctrl)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAR_ctrl)), test = Ftest())

# Interaction of distractor and task levels between ADHD & CTRL
cat("TEST CONTRAST: drAN_ctrl V ADHD", con_drAN_CvA)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAN_CvA)), test = Ftest())
cat("TEST CONTRAST: drAL_ctrl V ADHD", con_drAL_CvA)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAL_CvA)), test = Ftest())
cat("TEST CONTRAST: drAR_ctrl V ADHD", con_drAR_CvA)
summary(glht(fa_contr, linfct = mcp(all_factors = con_drAR_CvA)), test = Ftest())

```



## Distractor effect

```{r distractor_effect, warning = FALSE, fig.align = "center"}
if (PLOTS){
# Distractor effect, group level.
distractor_effect %>%
  ggplot(aes(x = Task, y = distractor_effect, linetype = Group, color = Group)) +
    geom_boxplot(outlier.alpha = 0, alpha = 1/5) +
    geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
    # geom_half_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha = 0) +
    xlab("Task") +
    ylab("Distractor effect") +
    ggtitle("Distractor effect, all task conditions, group level") +
    get(plot_theme)()
if (SAVE)
  ggsave(paste0(odir, "DistractorEffect.svg"))

# Distractor effect, group level, barchart with SEM.
p_dodge <- position_dodge(width = 0.9)

distractor_effect %>%
  group_by(Group, Task) %>%
  summarise(DE_mean = mean(distractor_effect),
            DE_sem = sd(distractor_effect)/sqrt(n())) %>%
  ggplot(aes(x = Task, y = DE_mean, fill = Group)) +
    geom_col(position = p_dodge) +
    geom_errorbar(aes(ymin = DE_mean - DE_sem, ymax = DE_mean + DE_sem),
                  position = p_dodge, width = 0.25) +
    xlab("Task") +
    ylab("Distractor effect") +
    ggtitle("Distractor effect, all task conditions, group level, +/- SEM") +
    scale_fill_brewer(palette = "Greys") +
    get(plot_theme)()

# Distractor effect, single subject.
distractor_effect %>%
  ggplot(aes(x = Task, y = distractor_effect, color = dom_resp)) +
    geom_line(aes(group = ID)) +
    geom_point() +
    facet_wrap(~Group) +
    xlab("Task") +
    ylab("Distractor effect") +
    ggtitle("Distractor effect, all task conditions, single subject") +
    get(plot_theme)() +
    theme(legend.position = "none")
}
# # Does response hand counter-balancing in CONTROL group affect DE?
# with(distractor_effect,
#   ks.test(distractor_effect[Group == "Control" & dom_resp == FALSE,]$distractor_effect,
#           distractor_effect[Group == "Control" & dom_resp == TRUE,]$distractor_effect))
```

### Statistics for distractor effect:

```{r distractor_effect_stats, warning = FALSE, fig.align = "center"}
# Mixed 2-way ANOVA.
de_stats <- ezANOVA(distractor_effect, dv = .(distractor_effect),
                    wid = .(ID),
                    within = .(Task),
                    between = .(Group),
                    type = 3, detailed = FALSE, return_aov = TRUE)
if (DIAGNOSTICS){
  ezanova_residuals <- purrr::map(de_stats$aov, residuals)
  ezanova_residuals_tbl <- enframe(ezanova_residuals) %>% unnest
  hist(ezanova_residuals_tbl$value)
  shapiro.test(ezanova_residuals_tbl$value)
  print(de_stats)
}

# distractor effect by lmer
de_lmer <- lmer(distractor_effect ~ Group*Task + (1|ID), data = distractor_effect)

distractor_effect$Group <- relevel(distractor_effect$Group, ref = "Control")
distractor_effect$all_factors <- with(distractor_effect, interaction(Group, Task))
levels(distractor_effect$all_factors)
de_contr <- lmer(distractor_effect ~ all_factors + (1|ID), data = distractor_effect)

```


### Contrasts for distractor effect:


```{r}
de.grid.lvls <- expand.grid(Task = c('AttendFull', 'AttendLeft', 'AttendRight'),
                            Group = c('ADHD', 'Control'))

cbind(de.grid.lvls, de = predict(de_lmer, newdata = de.grid.lvls, re.form=NA)) %>%
  ggplot(aes(Task, de, linetype=Group)) + geom_point() +
  geom_line(aes(group=Group),size=1) +
  theme_bw() + ggtitle("Distractor Effect") + ylab("Distractor Effect")

joint_tests(de_lmer)
joint_tests(de_lmer, by = "Group")
joint_tests(de_lmer, by = "Task")

# "main effect" of group
con_grp <- rbind("DE_group" = c(1,-1,1,-1,1,-1))
summary(glht(de_contr, linfct = mcp(all_factors = con_grp)), test = Ftest())

# # "main effect" of task within ADHD
con_FvLR_adhd <- rbind("FvLR_adhd" = c(0,1,0,-0.5,0,-0.5))
summary(glht(de_contr, linfct = mcp(all_factors = con_FvLR_adhd)), test = Ftest())
con_LvFR_adhd <- rbind("LvFR_adhd" = c(0,0.5,0,-1,0,0.5))
summary(glht(de_contr, linfct = mcp(all_factors = con_LvFR_adhd)), test = Ftest())
con_RvFL_adhd <- rbind("RvFL_adhd" = c(0,0.5,0,0.5,0,-1))
summary(glht(de_contr, linfct = mcp(all_factors = con_RvFL_adhd)), test = Ftest())

# "main effect" of task within CTRL
con_FvLR_ctrl <- rbind("FvLR_ctrl" = c(1,0,-0.5,0,-0.5,0))
summary(glht(de_contr, linfct = mcp(all_factors = con_FvLR_ctrl)), test = Ftest())
con_LvFR_ctrl <- rbind("LvFR_ctrl" = c(-0.5,0,1,0,-0.5,0))
summary(glht(de_contr, linfct = mcp(all_factors = con_LvFR_ctrl)), test = Ftest())
con_RvFL_ctrl <- rbind("RvFL_ctrl" = c(-0.5,0,-0.5,0,1,0))
summary(glht(de_contr, linfct = mcp(all_factors = con_RvFL_ctrl)), test = Ftest())

# interaction of group and task
con_F_CvA <- contrasts21(con_FvLR_adhd * -1 + con_FvLR_ctrl)
con_L_CvA <- contrasts21(con_LvFR_adhd * -1 + con_LvFR_ctrl)
con_R_CvA <- contrasts21(con_RvFL_adhd * -1 + con_RvFL_ctrl)

# Interaction of task levels and ADHD vs CTRL
cat("TEST CONTRAST: FvLR ctrl V ADHD", con_F_CvA)
summary(glht(de_contr, linfct = mcp(all_factors = con_F_CvA)), test = Ftest())
cat("TEST CONTRAST: LvFR ctrl V ADHD", con_L_CvA)
summary(glht(de_contr, linfct = mcp(all_factors = con_L_CvA)), test = Ftest())
cat("TEST CONTRAST: RvFL ctrl V ADHD", con_R_CvA)
summary(glht(de_contr, linfct = mcp(all_factors = con_R_CvA)), test = Ftest())
```

### DE summary

There was no effect of group on Distractor effect. Task = attend-Full differed strongly from Left/Right for CTRL group (F = 11), and this induced a between groups difference with ADHD in the same Task contrast (F = 4.2)